import fs from 'fs/promises'
import path from 'path'

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
interface HomepageData {
  title: string
  slug: string
  publishedAt: string
  blocks: any[]
}

interface CaseForPresentation {
  slug: string
  title: string
  challenge: string
  solution: string
  results: string
  technologies?: string
  images: string[]
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
async function readHomepageData(): Promise<HomepageData> {
  const jsonPath = path.join(process.cwd(), 'exported-homepage', 'homepage-data.json')
  const content = await fs.readFile(jsonPath, 'utf-8')
  return JSON.parse(content)
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–µ–π—Å–æ–≤
async function readCases(): Promise<CaseForPresentation[]> {
  const jsonPath = path.join(process.cwd(), 'exported-cases', 'cases-for-presentation.json')
  
  try {
    const content = await fs.readFile(jsonPath, 'utf-8')
    return JSON.parse(content)
  } catch (error) {
    console.error('‚ùå –§–∞–π–ª cases-for-presentation.json –Ω–µ –Ω–∞–π–¥–µ–Ω!')
    console.error('–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞: pnpm prepare:cases')
    throw error
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è SVG –ª–æ–≥–æ—Ç–∏–ø–∞
async function readLogo(): Promise<string> {
  const logoPath = path.join(process.cwd(), 'public', 'logo.svg')
  return await fs.readFile(logoPath, 'utf-8')
}


// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
async function generatePresentation() {
  console.log('üìä –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...')
  
  // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  const homepage = await readHomepageData()
  const cases = await readCases()
  const logoSvg = await readLogo()
  
  console.log(`‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${cases.length} –∫–µ–π—Å–æ–≤`)
  
  // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  const heroBlock = homepage.blocks.find(b => b.blockType === 'heroHome')
  const audienceBlock = homepage.blocks.find(b => b.blockType === 'targetAudience')
  const solutionBlock = homepage.blocks.find(b => b.blockType === 'solutionApproach')
  
  // –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
  const publicDir = path.join(process.cwd(), 'public')
  const getImagePath = (imgPath: string) => {
    // –£–±–∏—Ä–∞–µ–º /media/ –∏–∑ –ø—É—Ç–∏
    const cleanPath = imgPath.replace(/^\/media\//, '')
    return `file://${path.join(publicDir, 'media', cleanPath)}`
  }
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
  const html = `<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panfilov Consulting - –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #000;
      color: #fff;
    }
    
    .slide {
      width: 297mm;
      height: 210mm;
      padding: 60px 80px;
      page-break-after: always;
      page-break-inside: avoid;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .slide:last-child {
      page-break-after: auto;
    }
    
    /* –¢–∏—Ç—É–ª—å–Ω—ã–π —Å–ª–∞–π–¥ */
    .slide.title {
      justify-content: space-between;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    }
    
    .logo {
      width: 400px;
      margin-bottom: 40px;
    }
    
    .logo svg {
      width: 100%;
      height: auto;
    }
    
    h1 {
      font-size: 56px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 24px;
      background: linear-gradient(90deg, #fff 0%, #b7b8b9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      font-size: 28px;
      color: #b7b8b9;
      line-height: 1.4;
      max-width: 900px;
    }
    
    .contact {
      font-size: 24px;
      color: #b7b8b9;
      margin-top: 40px;
    }
    
    .contact a {
      color: #fff;
      text-decoration: none;
      border-bottom: 2px solid #b7b8b9;
      transition: border-color 0.3s;
    }
    
    /* –û–±—ã—á–Ω—ã–µ —Å–ª–∞–π–¥—ã */
    h2 {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 32px;
      color: #fff;
    }
    
    h3 {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #b7b8b9;
    }
    
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .grid {
      display: grid;
      gap: 24px;
    }
    
    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 32px;
      backdrop-filter: blur(10px);
    }
    
    .card h3 {
      font-size: 28px;
      margin-bottom: 16px;
      color: #fff;
    }
    
    .card p {
      font-size: 20px;
      line-height: 1.6;
      color: #b7b8b9;
    }
    
    .card-small {
      padding: 24px;
    }
    
    .card-small h3 {
      font-size: 24px;
    }
    
    .card-small p {
      font-size: 18px;
    }
    
    /* –°–ª–∞–π–¥—ã —Å –∫–µ–π—Å–∞–º–∏ */
    .case-text {
      font-size: 20px;
      line-height: 1.7;
      color: #e0e0e0;
    }
    
    .case-section {
      margin-bottom: 32px;
    }
    
    .case-section h3 {
      font-size: 32px;
      margin-bottom: 16px;
      color: #fff;
    }
    
    .case-images {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      height: 100%;
    }
    
    .case-image {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .case-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .list-item {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .list-number {
      font-size: 32px;
      font-weight: 700;
      color: #b7b8b9;
      min-width: 48px;
    }
    
    .list-content h4 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
    }
    
    .list-content p {
      font-size: 20px;
      line-height: 1.6;
      color: #b7b8b9;
    }
    
    /* –ü–µ—á–∞—Ç—å */
    @media print {
      body {
        background: #000;
      }
      
      .slide {
        page-break-after: always;
        page-break-inside: avoid;
      }
      
      @page {
        size: A4 landscape;
        margin: 0;
      }
    }
  </style>
</head>
<body>

  <!-- –°–ª–∞–π–¥ 1: –¢–∏—Ç—É–ª—å–Ω—ã–π -->
  <div class="slide title">
    <div>
      <div class="logo">${logoSvg}</div>
      <h1>${heroBlock?.heading || 'Panfilov Consulting'}</h1>
      <p class="subtitle">${heroBlock?.subheading || ''}</p>
    </div>
    <div class="contact">
      –ö–æ–Ω—Ç–∞–∫—Ç—ã: <a href="https://panfilov.consulting">panfilov.consulting</a> ‚Ä¢ <a href="mailto:contact@panfilov.consulting">contact@panfilov.consulting</a>
    </div>
  </div>

  <!-- –°–ª–∞–π–¥ 2: –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è -->
  <div class="slide">
    <h2>${audienceBlock?.heading || '–î–ª—è –∫–æ–≥–æ –Ω–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è'}</h2>
    <div class="content">
      <div class="grid grid-2">
        ${audienceBlock?.audiences?.slice(0, 4).map((audience: any) => `
          <div class="card card-small">
            <h3>${audience.title}</h3>
            <p>${audience.description}</p>
          </div>
        `).join('') || ''}
      </div>
    </div>
  </div>

  <!-- –°–ª–∞–π–¥—ã —Å –∫–µ–π—Å–∞–º–∏ -->
  ${cases.map(caseItem => `
    <!-- –°–ª–∞–π–¥: ${caseItem.title} - –û–ø–∏—Å–∞–Ω–∏–µ -->
    <div class="slide">
      <h2>${caseItem.title}</h2>
      <div class="content case-text">
        ${caseItem.challenge ? `
          <div class="case-section">
            <h3>–ó–∞–¥–∞—á–∞</h3>
            <p>${caseItem.challenge}</p>
          </div>
        ` : ''}
        ${caseItem.solution ? `
          <div class="case-section">
            <h3>–†–µ—à–µ–Ω–∏–µ</h3>
            <p>${caseItem.solution}</p>
          </div>
        ` : ''}
        ${caseItem.results ? `
          <div class="case-section">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
            <p>${caseItem.results}</p>
          </div>
        ` : ''}
      </div>
    </div>

    ${caseItem.images && caseItem.images.length >= 2 ? `
      <!-- –°–ª–∞–π–¥: ${caseItem.title} - –°–∫—Ä–∏–Ω—à–æ—Ç—ã -->
      <div class="slide">
        <h2>${caseItem.title}</h2>
        <div class="case-images">
          <div class="case-image">
            <img src="${caseItem.images[0]}" alt="–°–∫—Ä–∏–Ω—à–æ—Ç 1" />
          </div>
          <div class="case-image">
            <img src="${caseItem.images[1]}" alt="–°–∫—Ä–∏–Ω—à–æ—Ç 2" />
          </div>
        </div>
      </div>
    ` : ''}
  `).join('')}

  <!-- –°–ª–∞–π–¥: –£—Å–ª—É–≥–∏ -->
  <div class="slide">
    <h2>${solutionBlock?.heading || '–ù–∞—à –ø–æ–¥—Ö–æ–¥'}</h2>
    <p class="subtitle">${solutionBlock?.subheading || ''}</p>
    <div class="content" style="margin-top: 40px;">
      ${solutionBlock?.steps?.map((step: any, index: number) => `
        <div class="list-item">
          <div class="list-number">${index + 1}</div>
          <div class="list-content">
            <h4>${step.title}</h4>
            <p>${step.description}</p>
          </div>
        </div>
      `).join('') || ''}
    </div>
  </div>

  <!-- –°–ª–∞–π–¥: –ò—Ç–æ–≥–æ–≤—ã–π -->
  <div class="slide title">
    <div>
      <div class="logo">${logoSvg}</div>
      <h1>–ì–æ—Ç–æ–≤—ã –æ–±—Å—É–¥–∏—Ç—å –≤–∞—à –ø—Ä–æ–µ–∫—Ç?</h1>
      <p class="subtitle">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</p>
    </div>
    <div class="contact">
      <a href="https://panfilov.consulting">panfilov.consulting</a> ‚Ä¢ <a href="mailto:contact@panfilov.consulting">contact@panfilov.consulting</a>
    </div>
  </div>

</body>
</html>`
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML —Ñ–∞–π–ª
  const outputPath = path.join(process.cwd(), 'presentation.html')
  await fs.writeFile(outputPath, html, 'utf-8')
  
  console.log(`\n‚úÖ HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: ${outputPath}`)
  console.log(`\nüìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:`)
  console.log(`1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª presentation.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ`)
  console.log(`2. –ù–∞–∂–º–∏—Ç–µ Cmd+P (–∏–ª–∏ Ctrl+P –Ω–∞ Windows)`)
  console.log(`3. –í—ã–±–µ—Ä–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF"`)
  console.log(`4. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤—ã–±–µ—Ä–∏—Ç–µ:`)
  console.log(`   - –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: –ê–ª—å–±–æ–º–Ω–∞—è (Landscape)`)
  console.log(`   - –†–∞–∑–º–µ—Ä: A4`)
  console.log(`   - –ü–æ–ª—è: –ë–µ–∑ –ø–æ–ª–µ–π`)
  console.log(`   - –§–æ–Ω: –í–∫–ª—é—á–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –≥—Ä–∞—Ñ–∏–∫—É`)
  console.log(`\nüéâ –ì–æ—Ç–æ–≤–æ!`)
}

// –ó–∞–ø—É—Å–∫
generatePresentation().catch((error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error)
  process.exit(1)
})
